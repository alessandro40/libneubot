#!/usr/bin/env python

#
# Copyright (c) 2013
#     Nexa Center for Internet & Society, Politecnico di Torino (DAUIN)
#     and Simone Basso <bassosimone@gmail.com>.
#
# This file is part of Neubot <http://www.neubot.org/>.
#
# Neubot is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Neubot is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Neubot.  If not, see <http://www.gnu.org/licenses/>.
#

# pylint: disable = C0111

import json
import sys

def c_type(types, name):
    return types.get(name, name)

def gen_c_func(stream, types, retval_type, func_name, meth_args):
    retval_type = c_type(types, retval_type)
    stream.write(retval_type)
    nwritten = len(retval_type)
    if not retval_type.endswith("*"):
        stream.write(" ")
        nwritten += 1
    stream.write("%s(" % func_name)
    nwritten += len(func_name) + 1
    if meth_args:
        for index, meth_arg in enumerate(meth_args):
            if index > 0:
                stream.write(", ")
                nwritten += 2
            argtype = c_type(types, meth_arg[0])
            if nwritten + len(argtype) >= 78:
                stream.write("\n")
                stream.write("    ")
                nwritten = 4
            stream.write(argtype)
            nwritten += len(argtype)
    else:
        stream.write("void")
    stream.write(");\n")
    stream.write("\n")

def gen_c_init(stream, types, class_name, init_args):
    gen_c_func(
               stream,
               types,
               class_name + "_p",
               class_name + "_construct",
               init_args
              )

def gen_c_del(stream, types, class_name):
    gen_c_func(
               stream,
               types,
               "void",
               class_name + "_free",
               [
                (class_name + "_p", "self")
               ]
              )

def gen_c_method(stream, types, class_name, retval_type,
                      meth_name, meth_args):
    meth_args.insert(0, (class_name + "_p", "self"))
    gen_c_func(
               stream,
               types,
               retval_type,
               class_name + "_" + meth_name,
               meth_args
              )

def main():
    path = sys.argv[1]
    filep = open(path, "r")
    interface = json.load(filep)
    stream = sys.stdout

    stream.write("/*\n")
    stream.write(" * LibNeubot interface - Public domain.\n")
    stream.write(" * WARNING: Autogenerated file - do not edit!\n")
    stream.write(" */\n")
    stream.write("\n")

    stream.write("#ifndef NEUBOT_H\n")
    stream.write("# define NEUBOT_H 65537\n")
    stream.write("\n")

    stream.write("#ifdef __cplusplus\n")
    stream.write("extern \"C\" {\n")
    stream.write("#endif\n")
    stream.write("\n")

    stream.write("/* Hooks and slots: */\n")
    stream.write("\n")
    stream.write("typedef void (*neubot_hook_vo)(void *);\n")
    stream.write("typedef void (*neubot_hook_vos)(void *, const char *);\n")
    stream.write("\n")
    stream.write("typedef void (*neubot_slot_vo)(void *);\n")
    stream.write("typedef void (*neubot_slot_vos)(void *, const char *);\n")
    stream.write("\n")

    types = {
        "Object": "void *",
        "cstring": "const char *",
        "hook_vo": "neubot_hook_vo",
        "hook_vos": "neubot_hook_vos",
        "slot_vo": "neubot_slot_vo",
        "slot_vos": "neubot_slot_vos",
        "status_t": "int",
        "void_p": "void *",
    }

    stream.write("/* Classes: */\n")
    stream.write("\n")

    for class_name in sorted(interface["classes"]):
        stream.write("struct %s;\n" % class_name)
        types[class_name + "_p"] = "struct " + class_name + " *"
        types[class_name] = "struct " + class_name

    stream.write("\n")

    for class_name in sorted(interface["classes"]):
        stream.write("/* %s API: */\n" % class_name)
        stream.write("\n")
        for method_info in interface["classes"][class_name]:
            if method_info[0] == "__construct__":
                gen_c_init(stream, types, class_name, method_info[1:])
            elif method_info[0] == "__destroy__":
                gen_c_del(stream, types, class_name)
            else:
                gen_c_method(stream, types, class_name, method_info[0],
                  method_info[1], method_info[2:])

    stream.write("#ifdef __cplusplus\n")
    stream.write("}\n")
    stream.write("#endif\n")
    stream.write("\n")

    stream.write("#endif  /* NEUBOT_H */\n")

if __name__ == "__main__":
    main()
